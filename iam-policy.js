"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CustomIamPolicyConstruct = exports.verifyStatementCount = exports.verifyRoleCount = exports.generateIamPolicyName = exports.CustomIamPolicySchema = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const aws_ssm_1 = require("aws-cdk-lib/aws-ssm");
const constructs_1 = require("constructs");
const lodash_1 = require("lodash");
const zod_1 = require("zod");
const resource_tag_1 = require("./resource-tag");
const utils_1 = require("./utils");
/**
 * CustomIamPolicySchema
 *
 * @param awsEnvironment {@link AwsEnvironment}
 * @param resourceOwner {@link PulsifiTeam}
 * @prop resourceName
 */
exports.CustomIamPolicySchema = resource_tag_1.CustomResourceTagSchema.omit({
    resourceName: true,
}).extend({
    resourceName: zod_1.z
        .string()
        .min(1)
        .max(118)
        .refine((value) => {
        if (value.length > 0) {
            return (0, lodash_1.kebabCase)(value);
        }
        return "";
    }, utils_1.PulsifiCustomCdkError.NON_KEBAB_CASE),
});
/**
 * generateIamPolicyName
 *
 * @param props {@link CustomIamPolicyProps}
 * @returns output: (example: demo-api-policy)
 */
const generateIamPolicyName = (props) => {
    const formattedKebabCaseName = (0, lodash_1.kebabCase)(props.resourceName);
    return `${formattedKebabCaseName}-policy`;
};
exports.generateIamPolicyName = generateIamPolicyName;
/**
 * verifyRoleCount
 *
 * Checks role field is not empty
 *
 * @param props {@link CustomIamPolicyProps}
 */
const verifyRoleCount = (props) => {
    if (props?.roles && props.roles.length < 1) {
        throw new Error(utils_1.PulsifiCustomCdkError.IAM_POLICY_INVALID_ROLES);
    }
};
exports.verifyRoleCount = verifyRoleCount;
/**
 * verifyStatementCount
 *
 * Checks policy field is not empty
 *
 * @param props {@link CustomIamPolicyProps}
 */
const verifyStatementCount = (props) => {
    if (props?.statements && props.statements.length < 1) {
        throw new Error(utils_1.PulsifiCustomCdkError.IAM_POLICY_INVALID_STATEMENTS);
    }
};
exports.verifyStatementCount = verifyStatementCount;
class CustomIamPolicyConstruct extends constructs_1.Construct {
    /**
     * CustomIamPolicyConstruct
     *
     * Generates a standard IAM policy, please create separately if you have a custom usecase.
     *
     * Aws region abbreviation will be read from AWS account's "/configs/AWS_REGION_ABBR"
     * parameter store
     *
     * @readonly iamPolicy
     *
     * @param scope {@link Construct}
     * @param id
     * @param props {@link CustomIamPolicyProps}
     */
    constructor(scope, id, props) {
        super(scope, id);
        const utils = new utils_1.PulsifiUtils();
        const zodCheckOutput = utils.verifyCustomSchema(exports.CustomIamPolicySchema, props);
        if (!zodCheckOutput.success) {
            throw new Error(JSON.stringify(zodCheckOutput.message));
        }
        (0, exports.verifyRoleCount)(props);
        (0, exports.verifyStatementCount)(props);
        const awsRegionAbbr = aws_ssm_1.StringParameter.valueForStringParameter(this, "/configs/AWS_REGION_ABBR");
        const managedPolicyName = `${(0, exports.generateIamPolicyName)(props)}-${awsRegionAbbr}`;
        this.iamPolicy = new aws_iam_1.ManagedPolicy(this, "CustomIamPolicy", {
            managedPolicyName,
            statements: props.statements,
            roles: props.roles,
        });
        aws_cdk_lib_1.Tags.of(this).add("Name", managedPolicyName);
        aws_cdk_lib_1.Tags.of(this).add("Owner", props.resourceOwner);
        aws_cdk_lib_1.Tags.of(this).add("Environment", props.awsEnvironment);
    }
}
exports.CustomIamPolicyConstruct = CustomIamPolicyConstruct;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWFtLXBvbGljeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL2xpYi9pYW0tcG9saWN5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDZDQUFtQztBQUNuQyxpREFJNkI7QUFDN0IsaURBQXNEO0FBQ3RELDJDQUF1QztBQUN2QyxtQ0FBbUM7QUFDbkMsNkJBQXdCO0FBQ3hCLGlEQUF5RDtBQUN6RCxtQ0FBOEQ7QUFFOUQ7Ozs7OztHQU1HO0FBQ1UsUUFBQSxxQkFBcUIsR0FBRyxzQ0FBdUIsQ0FBQyxJQUFJLENBQUM7SUFDakUsWUFBWSxFQUFFLElBQUk7Q0FDbEIsQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUNULFlBQVksRUFBRSxPQUFDO1NBQ2IsTUFBTSxFQUFFO1NBQ1IsR0FBRyxDQUFDLENBQUMsQ0FBQztTQUNOLEdBQUcsQ0FBQyxHQUFHLENBQUM7U0FDUixNQUFNLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtRQUNqQixJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDdEIsT0FBTyxJQUFBLGtCQUFTLEVBQUMsS0FBSyxDQUFDLENBQUM7UUFDekIsQ0FBQztRQUNELE9BQU8sRUFBRSxDQUFDO0lBQ1gsQ0FBQyxFQUFFLDZCQUFxQixDQUFDLGNBQWMsQ0FBQztDQUN6QyxDQUFDLENBQUM7QUFjSDs7Ozs7R0FLRztBQUNJLE1BQU0scUJBQXFCLEdBQUcsQ0FBQyxLQUEyQixFQUFVLEVBQUU7SUFDNUUsTUFBTSxzQkFBc0IsR0FBRyxJQUFBLGtCQUFTLEVBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBRTdELE9BQU8sR0FBRyxzQkFBc0IsU0FBUyxDQUFDO0FBQzNDLENBQUMsQ0FBQztBQUpXLFFBQUEscUJBQXFCLHlCQUloQztBQUVGOzs7Ozs7R0FNRztBQUNJLE1BQU0sZUFBZSxHQUFHLENBQUMsS0FBMkIsRUFBUSxFQUFFO0lBQ3BFLElBQUksS0FBSyxFQUFFLEtBQUssSUFBSSxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztRQUM1QyxNQUFNLElBQUksS0FBSyxDQUFDLDZCQUFxQixDQUFDLHdCQUF3QixDQUFDLENBQUM7SUFDakUsQ0FBQztBQUNGLENBQUMsQ0FBQztBQUpXLFFBQUEsZUFBZSxtQkFJMUI7QUFFRjs7Ozs7O0dBTUc7QUFDSSxNQUFNLG9CQUFvQixHQUFHLENBQUMsS0FBMkIsRUFBUSxFQUFFO0lBQ3pFLElBQUksS0FBSyxFQUFFLFVBQVUsSUFBSSxLQUFLLENBQUMsVUFBVSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztRQUN0RCxNQUFNLElBQUksS0FBSyxDQUFDLDZCQUFxQixDQUFDLDZCQUE2QixDQUFDLENBQUM7SUFDdEUsQ0FBQztBQUNGLENBQUMsQ0FBQztBQUpXLFFBQUEsb0JBQW9CLHdCQUkvQjtBQUVGLE1BQWEsd0JBQXlCLFNBQVEsc0JBQVM7SUFHdEQ7Ozs7Ozs7Ozs7Ozs7T0FhRztJQUNILFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBMkI7UUFDcEUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixNQUFNLEtBQUssR0FBRyxJQUFJLG9CQUFZLEVBQUUsQ0FBQztRQUVqQyxNQUFNLGNBQWMsR0FBRyxLQUFLLENBQUMsa0JBQWtCLENBRzdDLDZCQUFxQixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2hDLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDN0IsTUFBTSxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQ3pELENBQUM7UUFFRCxJQUFBLHVCQUFlLEVBQUMsS0FBSyxDQUFDLENBQUM7UUFDdkIsSUFBQSw0QkFBb0IsRUFBQyxLQUFLLENBQUMsQ0FBQztRQUU1QixNQUFNLGFBQWEsR0FBRyx5QkFBZSxDQUFDLHVCQUF1QixDQUM1RCxJQUFJLEVBQ0osMEJBQTBCLENBQzFCLENBQUM7UUFFRixNQUFNLGlCQUFpQixHQUFHLEdBQUcsSUFBQSw2QkFBcUIsRUFBQyxLQUFLLENBQUMsSUFBSSxhQUFhLEVBQUUsQ0FBQztRQUU3RSxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksdUJBQWEsQ0FBQyxJQUFJLEVBQUUsaUJBQWlCLEVBQUU7WUFDM0QsaUJBQWlCO1lBQ2pCLFVBQVUsRUFBRSxLQUFLLENBQUMsVUFBVTtZQUM1QixLQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUs7U0FDbEIsQ0FBQyxDQUFDO1FBRUgsa0JBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO1FBQzdDLGtCQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2hELGtCQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsS0FBSyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQ3hELENBQUM7Q0FDRDtBQWxERCw0REFrREMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUYWdzIH0gZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQge1xuXHR0eXBlIElSb2xlLFxuXHRNYW5hZ2VkUG9saWN5LFxuXHR0eXBlIFBvbGljeVN0YXRlbWVudCxcbn0gZnJvbSBcImF3cy1jZGstbGliL2F3cy1pYW1cIjtcbmltcG9ydCB7IFN0cmluZ1BhcmFtZXRlciB9IGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mtc3NtXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tIFwiY29uc3RydWN0c1wiO1xuaW1wb3J0IHsga2ViYWJDYXNlIH0gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0IHsgeiB9IGZyb20gXCJ6b2RcIjtcbmltcG9ydCB7IEN1c3RvbVJlc291cmNlVGFnU2NoZW1hIH0gZnJvbSBcIi4vcmVzb3VyY2UtdGFnXCI7XG5pbXBvcnQgeyBQdWxzaWZpQ3VzdG9tQ2RrRXJyb3IsIFB1bHNpZmlVdGlscyB9IGZyb20gXCIuL3V0aWxzXCI7XG5cbi8qKlxuICogQ3VzdG9tSWFtUG9saWN5U2NoZW1hXG4gKlxuICogQHBhcmFtIGF3c0Vudmlyb25tZW50IHtAbGluayBBd3NFbnZpcm9ubWVudH1cbiAqIEBwYXJhbSByZXNvdXJjZU93bmVyIHtAbGluayBQdWxzaWZpVGVhbX1cbiAqIEBwcm9wIHJlc291cmNlTmFtZVxuICovXG5leHBvcnQgY29uc3QgQ3VzdG9tSWFtUG9saWN5U2NoZW1hID0gQ3VzdG9tUmVzb3VyY2VUYWdTY2hlbWEub21pdCh7XG5cdHJlc291cmNlTmFtZTogdHJ1ZSxcbn0pLmV4dGVuZCh7XG5cdHJlc291cmNlTmFtZTogelxuXHRcdC5zdHJpbmcoKVxuXHRcdC5taW4oMSlcblx0XHQubWF4KDExOClcblx0XHQucmVmaW5lKCh2YWx1ZSkgPT4ge1xuXHRcdFx0aWYgKHZhbHVlLmxlbmd0aCA+IDApIHtcblx0XHRcdFx0cmV0dXJuIGtlYmFiQ2FzZSh2YWx1ZSk7XG5cdFx0XHR9XG5cdFx0XHRyZXR1cm4gXCJcIjtcblx0XHR9LCBQdWxzaWZpQ3VzdG9tQ2RrRXJyb3IuTk9OX0tFQkFCX0NBU0UpLFxufSk7XG5cbi8qKlxuICogQ3VzdG9tSWFtUG9saWN5UHJvcHNcbiAqXG4gKiBAcGFyYW0gYXdzRW52aXJvbm1lbnQge0BsaW5rIEF3c0Vudmlyb25tZW50fVxuICogQHBhcmFtIHJlc291cmNlT3duZXIge0BsaW5rIFB1bHNpZmlUZWFtfVxuICogQHByb3AgcmVzb3VyY2VOYW1lXG4gKi9cbmV4cG9ydCB0eXBlIEN1c3RvbUlhbVBvbGljeVByb3BzID0gei5pbmZlcjx0eXBlb2YgQ3VzdG9tSWFtUG9saWN5U2NoZW1hPiAmIHtcblx0cm9sZXM6IElSb2xlW107XG5cdHN0YXRlbWVudHM6IFBvbGljeVN0YXRlbWVudFtdO1xufTtcblxuLyoqXG4gKiBnZW5lcmF0ZUlhbVBvbGljeU5hbWVcbiAqXG4gKiBAcGFyYW0gcHJvcHMge0BsaW5rIEN1c3RvbUlhbVBvbGljeVByb3BzfVxuICogQHJldHVybnMgb3V0cHV0OiAoZXhhbXBsZTogZGVtby1hcGktcG9saWN5KVxuICovXG5leHBvcnQgY29uc3QgZ2VuZXJhdGVJYW1Qb2xpY3lOYW1lID0gKHByb3BzOiBDdXN0b21JYW1Qb2xpY3lQcm9wcyk6IHN0cmluZyA9PiB7XG5cdGNvbnN0IGZvcm1hdHRlZEtlYmFiQ2FzZU5hbWUgPSBrZWJhYkNhc2UocHJvcHMucmVzb3VyY2VOYW1lKTtcblxuXHRyZXR1cm4gYCR7Zm9ybWF0dGVkS2ViYWJDYXNlTmFtZX0tcG9saWN5YDtcbn07XG5cbi8qKlxuICogdmVyaWZ5Um9sZUNvdW50XG4gKlxuICogQ2hlY2tzIHJvbGUgZmllbGQgaXMgbm90IGVtcHR5XG4gKlxuICogQHBhcmFtIHByb3BzIHtAbGluayBDdXN0b21JYW1Qb2xpY3lQcm9wc31cbiAqL1xuZXhwb3J0IGNvbnN0IHZlcmlmeVJvbGVDb3VudCA9IChwcm9wczogQ3VzdG9tSWFtUG9saWN5UHJvcHMpOiB2b2lkID0+IHtcblx0aWYgKHByb3BzPy5yb2xlcyAmJiBwcm9wcy5yb2xlcy5sZW5ndGggPCAxKSB7XG5cdFx0dGhyb3cgbmV3IEVycm9yKFB1bHNpZmlDdXN0b21DZGtFcnJvci5JQU1fUE9MSUNZX0lOVkFMSURfUk9MRVMpO1xuXHR9XG59O1xuXG4vKipcbiAqIHZlcmlmeVN0YXRlbWVudENvdW50XG4gKlxuICogQ2hlY2tzIHBvbGljeSBmaWVsZCBpcyBub3QgZW1wdHlcbiAqXG4gKiBAcGFyYW0gcHJvcHMge0BsaW5rIEN1c3RvbUlhbVBvbGljeVByb3BzfVxuICovXG5leHBvcnQgY29uc3QgdmVyaWZ5U3RhdGVtZW50Q291bnQgPSAocHJvcHM6IEN1c3RvbUlhbVBvbGljeVByb3BzKTogdm9pZCA9PiB7XG5cdGlmIChwcm9wcz8uc3RhdGVtZW50cyAmJiBwcm9wcy5zdGF0ZW1lbnRzLmxlbmd0aCA8IDEpIHtcblx0XHR0aHJvdyBuZXcgRXJyb3IoUHVsc2lmaUN1c3RvbUNka0Vycm9yLklBTV9QT0xJQ1lfSU5WQUxJRF9TVEFURU1FTlRTKTtcblx0fVxufTtcblxuZXhwb3J0IGNsYXNzIEN1c3RvbUlhbVBvbGljeUNvbnN0cnVjdCBleHRlbmRzIENvbnN0cnVjdCB7XG5cdHB1YmxpYyByZWFkb25seSBpYW1Qb2xpY3k6IE1hbmFnZWRQb2xpY3k7XG5cblx0LyoqXG5cdCAqIEN1c3RvbUlhbVBvbGljeUNvbnN0cnVjdFxuXHQgKlxuXHQgKiBHZW5lcmF0ZXMgYSBzdGFuZGFyZCBJQU0gcG9saWN5LCBwbGVhc2UgY3JlYXRlIHNlcGFyYXRlbHkgaWYgeW91IGhhdmUgYSBjdXN0b20gdXNlY2FzZS5cblx0ICpcblx0ICogQXdzIHJlZ2lvbiBhYmJyZXZpYXRpb24gd2lsbCBiZSByZWFkIGZyb20gQVdTIGFjY291bnQncyBcIi9jb25maWdzL0FXU19SRUdJT05fQUJCUlwiXG5cdCAqIHBhcmFtZXRlciBzdG9yZVxuXHQgKlxuXHQgKiBAcmVhZG9ubHkgaWFtUG9saWN5XG5cdCAqXG5cdCAqIEBwYXJhbSBzY29wZSB7QGxpbmsgQ29uc3RydWN0fVxuXHQgKiBAcGFyYW0gaWRcblx0ICogQHBhcmFtIHByb3BzIHtAbGluayBDdXN0b21JYW1Qb2xpY3lQcm9wc31cblx0ICovXG5cdGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBDdXN0b21JYW1Qb2xpY3lQcm9wcykge1xuXHRcdHN1cGVyKHNjb3BlLCBpZCk7XG5cblx0XHRjb25zdCB1dGlscyA9IG5ldyBQdWxzaWZpVXRpbHMoKTtcblxuXHRcdGNvbnN0IHpvZENoZWNrT3V0cHV0ID0gdXRpbHMudmVyaWZ5Q3VzdG9tU2NoZW1hPFxuXHRcdFx0dHlwZW9mIEN1c3RvbUlhbVBvbGljeVNjaGVtYSxcblx0XHRcdEN1c3RvbUlhbVBvbGljeVByb3BzXG5cdFx0PihDdXN0b21JYW1Qb2xpY3lTY2hlbWEsIHByb3BzKTtcblx0XHRpZiAoIXpvZENoZWNrT3V0cHV0LnN1Y2Nlc3MpIHtcblx0XHRcdHRocm93IG5ldyBFcnJvcihKU09OLnN0cmluZ2lmeSh6b2RDaGVja091dHB1dC5tZXNzYWdlKSk7XG5cdFx0fVxuXG5cdFx0dmVyaWZ5Um9sZUNvdW50KHByb3BzKTtcblx0XHR2ZXJpZnlTdGF0ZW1lbnRDb3VudChwcm9wcyk7XG5cblx0XHRjb25zdCBhd3NSZWdpb25BYmJyID0gU3RyaW5nUGFyYW1ldGVyLnZhbHVlRm9yU3RyaW5nUGFyYW1ldGVyKFxuXHRcdFx0dGhpcyxcblx0XHRcdFwiL2NvbmZpZ3MvQVdTX1JFR0lPTl9BQkJSXCIsXG5cdFx0KTtcblxuXHRcdGNvbnN0IG1hbmFnZWRQb2xpY3lOYW1lID0gYCR7Z2VuZXJhdGVJYW1Qb2xpY3lOYW1lKHByb3BzKX0tJHthd3NSZWdpb25BYmJyfWA7XG5cblx0XHR0aGlzLmlhbVBvbGljeSA9IG5ldyBNYW5hZ2VkUG9saWN5KHRoaXMsIFwiQ3VzdG9tSWFtUG9saWN5XCIsIHtcblx0XHRcdG1hbmFnZWRQb2xpY3lOYW1lLFxuXHRcdFx0c3RhdGVtZW50czogcHJvcHMuc3RhdGVtZW50cyxcblx0XHRcdHJvbGVzOiBwcm9wcy5yb2xlcyxcblx0XHR9KTtcblxuXHRcdFRhZ3Mub2YodGhpcykuYWRkKFwiTmFtZVwiLCBtYW5hZ2VkUG9saWN5TmFtZSk7XG5cdFx0VGFncy5vZih0aGlzKS5hZGQoXCJPd25lclwiLCBwcm9wcy5yZXNvdXJjZU93bmVyKTtcblx0XHRUYWdzLm9mKHRoaXMpLmFkZChcIkVudmlyb25tZW50XCIsIHByb3BzLmF3c0Vudmlyb25tZW50KTtcblx0fVxufVxuIl19